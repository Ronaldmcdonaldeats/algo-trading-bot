version: '3.3'

# TRADING BOT DEPLOYMENT - MODULAR ARCHITECTURE (Docker-Compose 1.25 Compatible)
# Quick Start: docker-compose up
# Services: dashboard (5000), api (5001), postgres (5432), redis (6379)
# Security: All ports bound to 127.0.0.1 (localhost only), SSH tunnels required for remote access

services:
  # PostgreSQL Database - Trade journal, logs, performance metrics
  postgres:
    image: postgres:15-alpine
    container_name: trading-bot-db
    environment:
      POSTGRES_USER: trading_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_DB: trading_bot
    ports:
      - "127.0.0.1:5432:5432"  # Only accessible locally (localhost)
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trading_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache - Trade tracking, real-time metrics, session management
  redis:
    image: redis:7-alpine
    container_name: trading-bot-cache
    ports:
      - "127.0.0.1:6379:6379"  # Only accessible locally (localhost)
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Core API Service - Strategy execution, trade management, backtest engine
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-bot-api
    ports:
      - "127.0.0.1:5001:5001"  # Only accessible locally via SSH tunnel
    environment:
      PYTHONUNBUFFERED: "1"
      FLASK_ENV: production
      LOG_LEVEL: INFO
      DB_URL: postgresql://trading_user:${DB_PASSWORD:-changeme}@postgres:5432/trading_bot
      REDIS_URL: redis://redis:6379/0
      MODE: paper  # paper or live
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./data:/app/data
      - ./backups:/app/backups
    command: gunicorn --bind 0.0.0.0:5001 --workers 2 --worker-class sync --timeout 300 --error-logfile - --access-logfile - trading_bot.web_api:app
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # Web Dashboard - Real-time monitoring, P&L tracking, charts
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-bot-dashboard
    ports:
      - "127.0.0.1:5000:5000"  # Only accessible locally via SSH tunnel
    environment:
      PYTHONUNBUFFERED: "1"
      FLASK_ENV: production
      API_URL: http://api:5001
      REDIS_URL: redis://redis:6379/0
      DB_URL: postgresql://trading_user:${DB_PASSWORD:-changeme}@postgres:5432/trading_bot
    volumes:
      - ./logs:/app/logs
    command: gunicorn --bind 0.0.0.0:5000 --workers 2 --worker-class sync --timeout 300 --error-logfile - --access-logfile - trading_bot.web_api:app
    depends_on:
      - api
      - postgres
      - redis
    restart: unless-stopped

  # Strategy Service - Monitors markets, generates signals, executes trades
  strategy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-bot-strategy
    environment:
      PYTHONUNBUFFERED: "1"
      LOG_LEVEL: INFO
      DB_URL: postgresql://trading_user:${DB_PASSWORD:-changeme}@postgres:5432/trading_bot
      REDIS_URL: redis://redis:6379/0
      MODE: ${MODE:-paper}
      CONFIG_FILE: /app/config/evolved_strategy_gen364.yaml
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./data:/app/data
    command: python -u scripts/trading_engine_live.py
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # Monitoring Service - Health checks, alerts, metrics collection
  monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-bot-monitor
    environment:
      PYTHONUNBUFFERED: "1"
      LOG_LEVEL: DEBUG
      DB_URL: postgresql://trading_user:${DB_PASSWORD:-changeme}@postgres:5432/trading_bot
      REDIS_URL: redis://redis:6379/0
    volumes:
      - ./logs:/app/logs
    command: python -u scripts/monitoring_service.py
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
