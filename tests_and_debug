#!/usr/bin/env python
"""Backtest with sufficient historical data."""

import sqlite3
import json
from trading_bot.paper.runner import run_paper_trading

print("=" * 80)
print("BACKTEST: Last 30 Days of Historical Data")
print("=" * 80)
print("Symbols: AAPL, MSFT, GOOGL, TSLA")
print("Period: 1 month (enough data for 20-day lookback)")
print()

# Run backtest
summary = run_paper_trading(
    config_path="configs/default.yaml",
    symbols=["AAPL", "MSFT", "GOOGL", "TSLA"],
    period="1mo",
    interval="1d",
    iterations=1,
    ui=False,
)

# Check results
conn = sqlite3.connect('data/trades.sqlite')
cursor = conn.cursor()

print("\n" + "=" * 80)
print("BACKTEST RESULTS")
print("=" * 80)

# Strategy signals
cursor.execute("SELECT COUNT(*) FROM strategy_decisions")
signal_count = cursor.fetchone()[0]
print(f"\nStrategy Signals Generated: {signal_count}")

# Buy signals
cursor.execute("SELECT COUNT(*) FROM strategy_decisions WHERE signal > 0")
buy_signals = cursor.fetchone()[0]
print(f"  Buy Signals (signal > 0): {buy_signals}")

# Sell signals
cursor.execute("SELECT COUNT(*) FROM strategy_decisions WHERE signal < 0")
sell_signals = cursor.fetchone()[0]
print(f"  Sell Signals (signal < 0): {sell_signals}")

# Orders
cursor.execute("SELECT COUNT(*) FROM orders")
order_count = cursor.fetchone()[0]
print(f"\nOrders Created: {order_count}")

if order_count > 0:
    cursor.execute("SELECT status, COUNT(*) FROM orders GROUP BY status")
    for status, count in cursor.fetchall():
        print(f"  {status}: {count}")
    
    # Show sample orders
    cursor.execute("""
    SELECT ts, symbol, side, qty, type, status 
    FROM orders 
    ORDER BY ts 
    LIMIT 5
    """)
    print(f"\n  First 5 orders:")
    for ts, symbol, side, qty, order_type, status in cursor.fetchall():
        print(f"    {ts} | {symbol:6} | {side:4} {qty:4} {order_type:7} | {status}")

# Fills
cursor.execute("SELECT COUNT(*) FROM fills")
fill_count = cursor.fetchone()[0]
print(f"\nTrades Executed (Fills): {fill_count}")

if fill_count > 0:
    cursor.execute("""
    SELECT ts, symbol, side, qty, price 
    FROM fills 
    ORDER BY ts 
    LIMIT 5
    """)
    print(f"  First 5 fills:")
    for ts, symbol, side, qty, price in cursor.fetchall():
        print(f"    {ts} | {symbol:6} | {side:4} {qty:4} @ ${price:.2f}")

# Portfolio
cursor.execute("SELECT cash, equity FROM portfolio_snapshots ORDER BY ts DESC LIMIT 1")
row = cursor.fetchone()
if row:
    cash, equity = row
    print(f"\nFinal Portfolio:")
    print(f"  Cash: ${cash:,.2f}")
    print(f"  Equity Value: ${equity:,.2f}")
    print(f"  Total: ${cash + equity:,.2f}")
    pnl = (cash + equity) - 100_000
    print(f"  P&L: ${pnl:+,.2f}")

# Positions
cursor.execute("SELECT symbol, qty, avg_price FROM position_snapshots WHERE qty != 0 ORDER BY ts DESC")
positions = {}
for symbol, qty, price in cursor.fetchall():
    if symbol not in positions:
        positions[symbol] = (qty, price)

if positions:
    print(f"\nOpen Positions:")
    for symbol, (qty, price) in positions.items():
        print(f"  {symbol}: {qty} shares @ ${price:.2f}")
else:
    print(f"\nOpen Positions: None (all cash)")

print("\n" + "=" * 80)
if fill_count > 0:
    print("✓ SUCCESS: Bot executed trades!")
else:
    print("✗ No trades executed (check strategy signals above)")
print("=" * 80)

conn.close()
