name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e .
        pip install pytest pytest-asyncio pytest-cov
    
    - name: Lint with ruff
      run: |
        pip install ruff
        ruff check src/ tests/ --select E,W,F
      continue-on-error: true
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src/trading_bot --cov-report=xml --cov-report=term-missing
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false
    
    - name: Test optimization modules
      run: |
        python -c "from trading_bot.utils.request_batcher import RequestBatcher, APIOptimizer; print('✓ request_batcher imports OK')"
        python -c "from trading_bot.utils.db_optimizer import DatabaseOptimizer; print('✓ db_optimizer imports OK')"
        python -c "from trading_bot.utils.async_web import AsyncHTTPClient; print('✓ async_web imports OK')"
        python -c "from trading_bot.utils.cache_manager import DataFrameCache; print('✓ cache_manager imports OK')"

  performance:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run performance benchmarks
      run: |
        python -c "
from trading_bot.utils.cache_manager import DataFrameCache
import pandas as pd
import time

# Benchmark caching performance
cache = DataFrameCache(max_size=100)
df = pd.DataFrame({'a': range(1000), 'b': range(1000)})

# Warm up
cache.set(df, symbol='AAPL', timeframe='1d')

# Benchmark gets
start = time.time()
for i in range(1000):
    cache.get(symbol='AAPL', timeframe='1d')
duration = time.time() - start

stats = cache.get_stats()
print(f'Cache get: {duration*1000:.2f}ms for 1000 ops ({stats[\"hit_rate\"]:.1f}% hit rate)')
print(f'Stats: {stats}')
"
      continue-on-error: true

  docker:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: algo-trading-bot:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit
    
    - name: Run security checks
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        cat bandit-report.json | python -m json.tool | head -50
      continue-on-error: true
